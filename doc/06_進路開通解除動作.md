# 進路の開通動作

## 進路の開通操作
進路の開通操作はアプリ画面上で発点てこをクリックして進路の始点を選び、次に着点ボタンをクリックする。発点てこを選ぶと着点ボタン選択モードへ遷移する。予め設定した進路データベースに登録されている着点ボタンが青く表示し、選択可能であることをユーザーに示す。問題なく進路が開通すると、画面に進路開通の状態が表示され、進路により鎖錠されている線路は黄色に着色される。

## 進路開通・解除処理のタイミング
進路の開通制御と解除制御のタイミングは、以下に示すようにアプリが現場装置と通信を行い、データベースの更新処理が完全に完了したタイミングで処理するようにする。処理中にデータ更新され、制御しようとしている進路内の軌道回路が処理中に在線状態に変化するなどがないようプログラムを構築する。

現場通信処理→データベース更新→連動処理（進路の開通・解除動作はこの期間で行う）→画面更新→（現場通信処理へ）

## 進路の開通動作フロー
開通させたい進路を選択したあとは、フローチャートに従って動作する。進路開通動作が始まると、まず発点てこに紐付けられている進路データが呼び出される。進路内の線路データリストを用いて支障進路の判定を行う。その後、進路内の軌道回路に車両在線がなく、ポイント切替とフィーダー電源切替がすべて進路データに従って動作したならば、進路内の線路を鎖錠（占有化）し、他進路と重複制御しないようにする。最後に信号機に進行を指示する信号の現示をするよう制御を行う。信号機の現示制御まで処理が完了すると進路開通の動作は完了となる。

アプリから現場の各装置へ制御する際は、装置へ送信した後の応答（返信）をチェックし、応答が無い、または受信した内容に問題がある場合は異常動作とみなし、新ロンボ開通失敗として処理するようにする。

# 進路の解除動作

## 進路の解除操作
進路の解除操作は進路開通中の発点てこを中立の位置に戻すことで進路の解除動作開始となる。解除を行う際は、右方向または左方向に倒れている発点てこをクリックする。クリックした後は次項で述べる進路の解除処理を行い、鎖状していた線路を順次解く。すべての進路鎖錠が解かれると、進路の解除完了となる。

## 進路の解除動作フロー
進路の解除動作は、車両の位置により動作が変化する。接近区間となる進路始点に車両が在線している場合は接近鎖錠動作、車両が進路内に進入し、到着点となる線路まで到達する前であれば、進路区分鎖錠動作とする。進路の解除動作に影響する範囲に車両の在線がない場合は、鎖錠していた線路をすぐに解除し、進路開通を解除とする。また、進路に解除秒数が設定されている場合は、鎖状している場合は、保留鎖錠動作とする。

接近鎖錠、保留鎖錠、進路区分鎖錠を行う場合は、進路データの状態を進路構成中から状態変化させ、進路解除待ちの状態とする。アプリはデータベースの情報更新と連動処理を繰り返し処理しているため、システム全体での動作が1周した次の周期で再度進路解除処理を実行する。次周期の解除処理で、軌道回路の在線情報などのデータベースに変化がある場合は、変化内容に応じて進路の解除処理を進行させる。

接近鎖錠動作は、進路データで指定した時間が経過後、進路の解除とする。接近鎖錠動作とする場合は、進路データのステータスを"進路開通中"から"時素解錠中"へ変更し、解除待ちのモードへと変更する。待ち時間はアプリ内で時間のカウントを行い、指定した時間が経過したならば再度フローを実行して解除処理を行う。保留鎖錠動作は無条件で、"時素解錠中"動作へ変更し、一定秒数の後、進路解除とする。

進路区分鎖錠の場合は、車両は時間の経過とともに、開通している進路に従って走行していくため、軌道回路の鎖錠を解いて進路区分鎖錠を行う。車両が進路の終点となる線路に完全に進入したら進路データの状態を"進路区分鎖錠中"から"進路未開通"へ変化させ、解除完了とする。