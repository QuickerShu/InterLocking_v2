# 進路データ

## 進路データ概要
進路データは電子連動アプリの中で最も重要なデータである。進路データは作成した配線略図と発点てこ・着点ボタンの配置情報から進路データを生成し、生成した進路上に含まれる各線路番号のデータリスト化と、進路による切替対象のポイントレールの抽出と方向の決定、制御する信号機を設定する。進路データは進路1つにつき1データとして作成し、データベースを構築する。例えば100進路を持つ連動装置であれば、100個の進路データを生成する。

進路データには走行する進路の始点となる線路から到着点となる線路までのすべての線路番号をデータ群として保持し、線路データ間に挟まれたポイントレールを進路の方向に合うようにポイント切替を行う。

作成した進路データは発点てこと紐付けを行う。てこが進路データを参照することで、どの着点ボタンに対して進路設定可能かを表示できるようにする。

## 進路データの定義
進路データは線路のデータ群のほか、進路データの管理番号、進路の方向、進路の状態、進路の種類、制御する信号機番号、進路内を走行する線路のすべての番号、切替対象とするポイント番号、接近鎖錠・保留鎖錠の秒数、進行定位の有無を1つのデータ群として定義する。このデータをデータベースとして構築し、連動装置の進路データとして管理する。

アプリ内でのデータ管理は、進路データの進路番号が0以外の値を持つとき、進路データを有効なデータと扱う。これはアプリ内で進路データの追加作成、データ削除に対応するためである。有効な進路データを削除する場合、進路番号を0に書き換えることでアプリ内では削除された進路として処理する。進路番号の付番はデータベースのメモリアドレスが0番地ならば、番地0の値に1加算した番号1を進路データの番号とする。生成できる進路データ数には上限を設けない。

アプリはこの進路データを使用して、ポイントレールの切替制御のほか、進路相互の支障判定、進路開通により制御する信号機の指定、接近鎖錠・保留鎖錠の時素解錠動作に使用する。

## 進路で走行する線路データ生成のための経路探索
進路で走行する線路のデータリスト生成は、発点てこ・着点ボタンの位置関係から配線略図のデータを用いて経路探索して生成する。経路探索の順序は、ポイントレールの直進方向を優先して探索し、見つからなければ直進方向として探索したポイントレールまで戻り、探索する方向を分岐側へ切り替えて探索する。

発点てこが配置された線路データを起点とし、右方向または左方向に経路探索し、目的地となる着点ボタンが配置されている線路番号を探す。すべての線路データは隣接する線路データの番号を保持しているため、線路データ相互間で接続されている。隣接する線路データの番号を順次参照することにより経路探索が可能で、探索方法は目的となる線路番号が見つかるまで総当たり探索とする。探索の結果、エンドレール等の終点となる線路番号まで到達しても目的の線路番号に到達しなければ、ポイントがある線路番号まで探索を戻し、別の経路を探索する。目的の着点ボタンにまで到達したならば、進路確定として進路データを生成する。