# 配線略図作図機能

## 概要
汎用的な装置とするため、ユーザーがアプリ上で配線略図を作成し、連動論理のデータベースを構築できるようにする。この配線略図を描くための機能が配線略図作図機能である。作図機能では、ユーザーが線路線形を自由に描けるようにするため、基本的なレールをパーツ化し、パーツを組み合わせることで線路線形を描くものとする。画面上に表示する配線略図はレイアウト全体を横長の線路配線に簡略化して作図する。

## レールパーツ化
配線略図を描くために必要な様々な線路の表記をパーツ化する。パーツは直線レール、曲線レール（折れ曲げ線）といった基本的なレールのほか、各種ポイントレール、クロッシング等をパーツとしてシンボル化する。

定義したシンボルを表に示す。

| | | | | | |
|:---:|:---:|:---:|:---:|:---:|:---:|
| 直線 | | 斜め直線 | | 絶縁クロス | |
| 曲線 | | クロッシング | | 左ダブルスリップ | |
| 左ポイント | | 左ポイント（45度） | | 右ダブルスリップ | |
| 右ポイント | | 右ポイント（45度） | | オーバークロス | |
| 左クロッシング | | エンドレール | | アンダークロス | |
| 右クロッシング | | レール絶縁 | | ジャンプレール | |
| Y字ポイント | | レール絶縁（45度） | | ダブルクロス | |

ユーザーが作図する際にはこのレールパーツを組み合わせて作図し、レイアウトの線路配線を画面内に再現する。パーツを画面内に配置する際は、配置時にパーツの回転を行う機能を有し、例えば曲線パーツは図の角度から0°、90°、180°、270°と回転して配置できるようにする。配置はマウス操作で行い、それぞれのパーツを繋げて配線略図を完成させていく。

レール絶縁は配線略図上で軌道回路を区分する際に用いる。使用するとアプリは電気的に区切られていると認識する。アプリ上でレール絶縁を挿入する位置は、現実のレイアウト上に挿入した絶縁となるべく位置が近くなるように配置して配線略図を作成する。

ジャンプレールは画面上での線路配置を見やすくするために離れたレールパーツ同士を同一の線路としてみなすために設けたパーツである。一般に鉄道模型のレイアウトはエンドレス（周回するレイアウト）なため、画面左端と右端で行き止まりではなく、同一の線路とみなすために使用する。

## レールパーツの線路化
前項で述べたレールのパーツを画面上に配置したのみでは、一つの連続した線路としてアプリ上では認識していない状態である。そこで、配置したレールパーツを連続した線路として認識するために、レールパーツ相互間をデータで結びつける。具体的には各レールパーツにID番号を振り、双方のパーツIDを参照することで一体のデータとする。ID番号0はデータなしを表し、未接続となる箇所には値に「0」を書き込む。ポイントレール等の複数の接続先を有するパーツはすべての接続先を記憶する。

データ化は互いのパーツが画面上で接続されていることを条件とし、接続していないレールパーツは別の線路として扱われる。

## 線路データの生成
前項で各レールパーツの線路化を行うと、次に閉そく区間や軌道回路区間などの制御しやすい区間に区切るために、電気的に同一区間と分類される複数のレールパーツを1つの線路データとして別に付番する。これを線路データ化と称する。ポイントレールは異なる線路間の境界点とみなし、それぞれ異なる線路番号を付番する。この付番により大量に接続された直線パーツや曲線パーツを直接参照せずに、1つのデータ塊として処理することで進路データベース化などの処理を簡略化する。線路データ間は相互に接続相手の線路番号を参照できるようにし、アプリ上においても線路配線の接続関係を持たせる。本装置で進路を制御する際の線路の単位は、この線路データを基本とする。

## ポイントレールの開通方向表示
ポイントレールは開通方向を画面上に表示し、ユーザーが現在どの方向にポイントレールが開通しているかを直感的に分かるようにデザインする。図はポイントレールが直進・分岐のどちらを向いているかを示した図である。この開通方向の表示切替は現場のポイント制御装置から受信した情報で判断して描画する。ポイント制御装置にてポイント切替を行うことに失敗した場合は、開通方向の表示は切替前の状態を保持するようにする。

## 線路の状態表示
作成した配線略図の各線路は、進路が開通している場合や軌道回路内に車両が在線している場合などの情報を画面に色で表示する。線路の色によって意味合いを分け、下図に示すような状態表示を定義する。在線時は赤色、進路が開通し線路が進路によって占有（鎖錠）されている時は黄色、現場機器から動力電源の通電を検知した場合は緑色、ユーザーが線路を選択し、何らかの操作をしようとしている場合は水色を着色する。

線路の状態表示が重複した場合は優先順位を設ける。例えば在線と鎖錠が同一線路内で生じた場合は鎖錠よりも車両の位置が優先して着色表示されるようにする。優先順位は選択の表示が最も強く、次に在線表示とする。

| 定義 | 色 | カラーコード | 優先順位 |
|:---|:---|:---|:---|
| 選択 | 水色 | #00FFFF | 高い |
| 在線 | 赤色 | #FF0000 | |
| 鎖錠 | 黄色 | #FFFF00 | |
| 通電 | 緑色 | #00FF00 | |
| 在線なし | 白色 | #FFFFFF | 低い |

## 線路データと現場情報の紐づけ
軌道回路の在線情報等は、生成された線路データにデータ紐付けをすることで情報を反映する。軌道回路情報については現場情報データとして、線路データとは別に管理する。これは、線路略図上で生成される線路データの数と軌道回路の数が一致しないためである。例えば、ポイントを含む軌道回路の場合、アプリ上の線路データは1つではなく、複数に及んで定義されるが、軌道回路は1つのみとなる。複数の線路データに軌道回路情報を伝達するため、軌道回路の情報を線路2にデータ紐付け（リンク）を行い、軌道回路の情報を線路2に転送する。在線情報を取得した線路2データから隣接の線路データ3,4にはポイントの開通方向に従って情報伝達を行い、1つの軌道回路として動作するようにする。この情報伝達は配線略図上で絶縁レールがあるパーツまで情報を渡す。

## 信号関係設備のデザイン
信号関係設備は初期版ではその多くは実装しない。ただし発点てこ、着点ボタンは進路制御に必要なため実装する。

発点てこは、進路の種類ごとにてこの色を変更して描画する。停車場間を走行する本線進路と停車場構内にて入換を行う進路の発点てこが同一色とするとユーザーにとって判別しづらくなるため、本線を走行するために使用するてこを赤色、入換信号機に使用するてこを白色、入換標識に使用するてこを緑色、開通テコを黄色とする。着点ボタンは進路の種類に依らず1種類とし、ボタンの色はWindowsのシステムカラーの灰色とする。

| てこの種類 | つまみ色 | デザイン | カラーコード | 使途 |
|:---|:---|:---|:---|:---|
| 信号てこ | 赤 | | #FF0000 | 本線用 |
| 入換信号てこ | 白 | | #FFFFFF | 構内入換用（防護区間あり） |
| 入換標識てこ | 緑 | | #00FF00 | 構内入換用（防護区間なし） |
| 開通てこ | 黄 | | #FFFF00 | 過走防護用 |
| 着点ボタン | 灰色 | | #EBEBEB | 全進路到着点 |