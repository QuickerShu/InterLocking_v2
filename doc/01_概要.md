# 電子連動ソフトウェア

## 電子連動アプリ概要

### 仕様
アプリは、下記機能を有する。
- DCCコマンドステーションDSAir2と無線接続し、ポイントなどを制御する
  - 初期Verはポイントのみを制御する。在線情報は取得できないので、在線情報の基づく進路開通制御機能はOFFにする
  - 将来的には信号機やレールへの電力供給リレーも制御可能とする
  - 在線検知情報を取得、常時状態監視しそれに基づく制御を行えるようにする
- 線路配線をユーザーが自由に描き、連動論理を構築できる
- 機器を接続せずに、作成した連動論理データを検証できる

アプリはブラウザ上で動作するWebアプリとする。Javascript言語を用い、htmlファイルからコントロールする。一部機能はタブレットなどのタッチパネルでの利用も想定したGUIとする。

### アプリ基本画面
アプリの画面はレイアウトの線路配線を模した配線略図で情報を表示し、進路開通操作を行う配線略図画面と、アプリ内で定義されているデータの一覧とその状態を表示する補助画面の大きく2種類の画面とする。

配線略図画面では画面に描かれる配線略図に色によって線路の状態を示し、現在開通中の進路や車両の位置を表示する。本装置における進路開通の操作方法は、レイアウトの規模によらず、常に進路選別式による進路開通操作とする。配線略図画面にはレイアウトの線路配線のほか、ユーザーが進路開通操作を行うための「発点てこ」と「着点ボタン」を配置する。進路選別式のため、発点てこは進路の始点となる線路上に配置し、着点ボタンは進路の終点となる位置に配置する。

補助画面では、運用する電子連動装置で登録されているデータが一覧で表示される。補助画面には進路一覧情報のほか、各軌道回路の状態表示一覧や現場信号機の詳細情報一覧表示など、設備ごとに詳細情報を表示する画面がある。進路一覧では、進路の開通状態などのステータスが表示され、進路開通中は赤色にし強調して表示する。

### アプリの操作
アプリの操作はマウス操作を基本とする。進路の開通操作を行う際は発点てこと着点ボタンの選択をマウス操作で行う。配線略図画面はマウスホイール操作とドラッグ操作で画面の移動をすることができ、大規模なレイアウトに対しても不自由なく直感的に操作できる。

一部のショートカットキーに対応し、ファイルを開く際は「O（オー）」、レールパーツの回転には「R」といったキー操作を実装し、マウス操作と併用して操作性を向上させる。

配線略図画面の画面スクロールや発点てこと着点ボタンの選択はタッチ操作で行えるようにする。

### 基本動作
アプリの基本動作は、現場通信処理、データベース更新、連動処理、画面更新の4つのステップを繰り返し動作するようにする。状態監視機能の実装後は、鉄道模型の車両はレイアウト上を走り続けるため、現場の装置から定期的に軌道回路の在線情報等を取得してアプリのデータ更新を行う必要がある。データ更新を行わないと、車両の在線位置が更新されないため、レイアウトの車両位置とデータが不一致して正常に動作しなくなる。

アプリケーションは、現場の装置から定期的に情報を取得してデータベース更新を行い、取得した情報をもとに進路の自動復位（設定した進路の自動解除動作）を行うことや、閉そく運転に関する編成の処理、鎖錠中の進路の解錠（進路区分鎖錠）などの連動処理を行う。連動処理後は、画面上の配線略図に表示する。一連の流れを繰り返し処理して運用する。

繰り返し処理の処理時間間隔は0.1秒間隔で現場装置の情報更新を行う動作とする。繰り返し処理の更新周期が長すぎる（例えば1.0秒）と、レイアウト上の車両位置とアプリの画面表示内容や連動処理にズレが生じ、編成番号の制御タイミングが遅れるなどの問題が生じる。逆に更新周期が短い（0.01秒）と、現場装置間との通信頻度が多くなり、情報の輻輳が生じて現場装置の処理が追い付かなくなる。