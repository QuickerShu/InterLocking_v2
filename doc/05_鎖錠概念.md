# 鎖錠概念の導入

## 概要
進路相互間の支障判定や鎖錠機能などはすべてアプリのソフトウェア処理で実現する。連動装置には様々な鎖錠の機能があり、すべての機能を備えることで安全に運転できる装置となる。

## てっ査鎖錠
てっ査鎖錠とは、「ポイントを含む軌道回路内に車両があるとき、その車両によってポイントを切替できないように鎖錠すること」である。線路データが在線の情報を取得した場合、線路データの端部に接続されるポイントレールは切替できないように鎖錠する。ポイントレールの同時切替が必要な渡り線等の場合は車両在線により鎖錠されるポイントが1箇所でも含まれる場合、すべてのポイントで鎖錠し、ポイント切替できないようにする。

## 進路鎖錠
進路鎖錠は車両が進路内を走行し、進路の終点へ到着するまで進路内の線路を鎖錠し、発点てこを復位（進路の解除操作）しても鎖錠を継続させる機能である。進路データで定義された各線路は進路の開通操作により、進路によって走行する線路を鎖錠（占有）する。発点てこを復位し、車両が進路内を走行して進路の終点まで到達した場合は進路鎖錠をすべて解く。

進路が複数の軌道回路で分割されている場合は、軌道回路単位で進路の鎖錠を解除する。分割して進路が解除される進路鎖錠のことを「進路区分鎖錠」という。

## 表示鎖錠
表示鎖錠は、信号機が進行信号から停止信号に切り替わらない場合、進路の解除を行わない機能である。進路の解除操作をしたならば、進路により制御していた信号機は直ちに停止信号へ切り替わらなければならない。進行信号を現示していると運転士から見れば進入して良いことになるため、進行現示から停止信号へ変化することに失敗すると、危険な動作になる。

今回の装置では、進路の解除操作を行った際、現場の信号機ユニットに対して停止信号制御を行う。停止信号制御に失敗した場合、進路の解除を行わないようにし、表示鎖錠としている。

## 接近鎖錠・保留鎖錠
進路の始点となる区間に車両が接近した直後で進路の解除操作を行った場合、高速で停車場へ接近する車両は急に停止できないため、信号機を超えてしまう恐れがある。信号機を超えた先にはポイントがあるため、進路の解除と同時に鎖錠を解くと、ポイントが切り替わる可能性があり、脱線の恐れがある。そこで、接近区間に車両が存在するならば、進路解除操作後は一定時間、進路の鎖錠を継続する。これを接近鎖錠という。

今回のアプリでは、接近鎖錠を行う区間は進路始点となる軌道回路の区間に在線した場合に、接近鎖錠を行うようにしている。鎖錠の時間は進路ごとに設定できるようにする。鉄道模型の場合、実際の鉄道よりも急制動が可能なため、設定秒数は10秒程度が妥当である。似た機能として、保留鎖錠というものがある。保留鎖錠の場合は、接近区間内に車両が存在するか否かに関わらず進路の解除操作後に一定時間、進路を鎖錠する。

アプリ上では、接近鎖錠・保留鎖錠により進路の解除に待ち時間が発生している間、「時素解錠中」のテロップを表示する。

## 片鎖錠
片鎖錠は2つの設備間で一方向にのみ鎖錠する仕組みである。片鎖錠の例として、開通てこによる過走防護と信号の現示アップがある。

過走防護とは進路終点となる線路に車両が進入する際、ブレーキ操作遅れにより進路の終点で止まりきれず、進路終点を超えてしまう過走に対して他車両と衝突しないようにする仕組みである。過走防護がない場合、隣接する別の線路を走行する車両と衝突する恐れがある。そこで、進入時に確認する信号機の信号を警戒信号とし、進入する車両の速度を低速度とする方法と過走の恐れがある区間を予め進路により鎖状する方法の2つを用いて防護を行う。過走防護を行うと衝突は避けられますが、前者は進入速度が遅いため、時間がかかること、後者は競合する進路の同時進出入ができないというデメリットがある。

そこで片鎖錠という概念を用いて、状況に応じて同時に進出可能とするか選択できる施策を行う。過走防護により過走の恐れがある区間の鎖錠を行ったならば、車両が高速度で進入するため、防護区間は車両が到着点となる線路で停止するまでは鎖錠を継続しなければならない。すなわち、過走の恐れがある区間の鎖錠は進路により鎖錠する関係となる。

過走防護の鎖錠は進路により鎖錠するが、過走防護により進路を鎖錠することはない。従って過走防護と進路の鎖錠関係は一方向な鎖錠関係になる。この鎖錠関係を片鎖錠と言う。

開通てこは進路の到着点となる線路に設ける黄色のてこであり、進路を延長する役割を持つ。今回のアプリでは、開通てこによる現示アップを再現する。開通てこにより過走区間の防護がされると、現場の信号機に現示アップ指示を行い、信号機は警戒信号から注意信号へ変化する。開通てこを操作せずに進路を開通し、警戒信号現示で進入する場合は他進路の同時進出入ができるため、過走防護のデメリットを回避できる。

## 線路の占有化による進路支障判定処理
進路相互間の支障判定は線路データがある特定の進路によって鎖錠（占有）されている場合、同一の進路を共有する他の進路は設定不可とする排他処理を行い、進路支障と判定する手法で実現する。本物の電子連動装置ではこの方式を「軌道回路予約方式」といい、今回製作した電子連動装置においても進路相互間での支障判定は同様の論理にて動作するようプログラムする。

開通しようとしている進路の全線路データを参照し、線路データが占有していないかを一つ一つチェックしていく。進路内の全線路が占有でないと判定できたならば、進路開通処理を実行する。

## 進路支障判定処理の例外
進路支障判定処理には例外処理を追加する。それは、走行する進路が複数に分割されて制作され、それぞれ進路開通制御を行った場合である。具体的には停車場を通過する優等列車灯を運転するために、停車場外から進入する進路と、停車場内から進出する進路を同時に開通させようとする場合である。

この例外処理は進路の始点と終点相互間のみで適用し、進路の中間から分岐するような分割された進路を制御することはないようにする。

この例外処理は進路開通操作時の他、進路を解除する際も同様に適用する。進路の始点と終点が重複しており、どちらか一方の進路にて開通制御中であれば解除しない処理を行う。この例外処理により、停車場へ進入する場内進路と停車場から進出する出発進路相互間で干渉しないようにする。